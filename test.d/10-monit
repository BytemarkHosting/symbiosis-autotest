#!/bin/bash

rm -f /etc/cron.d/symbiosis-monit
#
# This works for both lenny and squeeze+
#
for i in /etc/symbiosis/monit.d/disabled /tmp/dpkg.running ; do
  rm $i
done

do_monit() {
  #
  # Make sure clamav + spamassassin stay running
  #

  touch /srv/$(hostname)/config/anti{spam,virus}

  /usr/sbin/symbiosis-monit 
}

echo -n "I: Adding db.local.clamav.net alias to /etc/hosts"
echo "212.110.161.69 db.local.clamav.net" >> /etc/hosts
invoke-rc.d clamav-freshclam restart

echo -n "I: Waiting for clamav to download databases."
for i in $(seq 1 300) ; do

  if [ -f "/var/lib/clamav/main.cvd" -a -f "/var/lib/clamav/daily.cvd" ] ; then
     echo "done."
     invoke-rc.d clamav-daemon restart
     break
  fi

  echo -n "."
  sleep 1
done

#
# Have a couple of goes running monit 
#
trap do_monit ERR

do_monit
